DESC CUSTOMER;
SELECT * FROM CUSTOMER LIMIT 5;

-- Q1: WHAT IS THE TOTAL REVENUE GENERATED BY MALES VS FEMALES CUSTOMERS
SELECT GENDER, SUM(PURCHASE_AMOUNT) AS 'total_revenue'
FROM customer
GROUP BY GENDER;


-- Q2: WHICH CUSTOMER USED A DISCOUNT BUT STILL SPENT MORE THAN THE AVERAGE PURCHASE AMOUNT?
SELECT CUSTOMER_ID, DISCOUNT_APPLIED, PURCHASE_AMOUNT
FROM customer
WHERE discount_applied = 'Yes'
	AND PURCHASE_AMOUNT > (
		SELECT AVG(PURCHASE_AMOUNT)
        FROM CUSTOMER
    );

-- Q3: WHICH ARE THE TOP 5 PRODUCTS WITH THE HIGHEST AVERAGE REVIEW RATING
SELECT ITEM_PURCHASED AS 'TOP_5_PRODUCTS', ROUND(AVG(REVIEW_RATING), 2) AS 'AVG_REVIEW_RATING'
FROM CUSTOMER
GROUP BY ITEM_PURCHASED
ORDER BY 2 DESC LIMIT 5;

-- Q4: COMPARE THE AVG PURCHASE AMOUNT BETW STANDARD AND EXPRESS SHIPPING
SELECT SHIPPING_TYPE, AVG(PURCHASE_AMOUNT) AS AVG_PURCHASE_AMOUNT
FROM CUSTOMER
WHERE SHIPPING_TYPE IN ('STANDARD', 'EXPRESS')
GROUP BY SHIPPING_TYPE;

-- Q5: DO SUBCRIBED CUSTOMERS SPEND MORE? COMPARE SPEND AND TOTAL REVENUE BETW SUBSCRIBERS AND NON-SUBSCRIBERS
SELECT SUBSCRIPTION_STATUS, 
		COUNT(CUSTOMER_ID) AS TOTAL_CUSTOMERS, 
        AVG(PURCHASE_AMOUNT) AS AVG_SPEND, 
        SUM(PURCHASE_AMOUNT) AS TOTAL_REVENUE
FROM CUSTOMER
GROUP BY SUBSCRIPTION_STATUS
ORDER BY AVG_SPEND, TOTAL_REVENUE;

-- Q6: WHICH 5 PRODUCTS HAVE THE HIGHEST PERCENTAGE OF PURCHASES WITH DISCOUNT APPLIED?
SELECT ITEM_PURCHASED,
	ROUND(100 * SUM(CASE WHEN DISCOUNT_APPLIED = 'YES' THEN 1 ELSE 0 END) / COUNT(*), 2) AS DISCOUNT_RATE
FROM customer
GROUP BY ITEM_PURCHASED
ORDER BY DISCOUNT_RATE DESC
LIMIT 5;

-- Q7: SEGMENT CUSTOMERS INTO NEW, RETURNING, AND LOYAL BASED ON THEIR TOTAL AMOUNT OF PREVIOUS PURCHASES
-- AND SHOW THE COUNT OF EACH SEGMENT
WITH CUSTOMER_TYPE AS (
	SELECT CUSTOMER_ID, PREVIOUS_PURCHASES,
    CASE 
		WHEN PREVIOUS_PURCHASES = 1 THEN 'NEW'
        WHEN PREVIOUS_PURCHASES BETWEEN 2 AND 10 THEN 'RETURNING'
        ELSE 'LOYAL'
    END AS CUSTOMER_SEGMENT
    FROM CUSTOMER
)
SELECT CUSTOMER_SEGMENT, COUNT(T.CUSTOMER_SEGMENT) AS CUSTOMER_COUNT
FROM CUSTOMER C
JOIN CUSTOMER_TYPE T
ON C.CUSTOMER_ID = T.CUSTOMER_ID
GROUP BY T.CUSTOMER_SEGMENT;

-- Q8: WHAT ARE THE TOP 3 MOST PURCHASED PRODUCTS WITHIN EACH CATEGORY?
WITH ITEM_COUNTS AS (
	SELECT CATEGORY, ITEM_PURCHASED, COUNT(*) AS TOTAL_CUSTOMERS,
		ROW_NUMBER() OVER(PARTITION BY CATEGORY ORDER BY COUNT(*) DESC) AS RNK
	FROM CUSTOMER
	GROUP BY CATEGORY, ITEM_PURCHASED
)

SELECT RNK, CATEGORY, ITEM_PURCHASED, TOTAL_CUSTOMERS
FROM ITEM_COUNTS
WHERE RNK <= 3;

-- Q9: ARE CUSTOMERS WHO ARE REPEAT BUYERS (MORE THAN 5 PREVIOUS PURCHASES) ALSO LIKED TO SUBSCRIBE
SELECT SUBSCRIPTION_STATUS, COUNT(*)
FROM CUSTOMER
WHERE PREVIOUS_PURCHASES > 5
GROUP BY SUBSCRIPTION_STATUS;


-- Q10: WHAT IS THE REVENUE CONTRIBUTION OF EACH AGE GROUP
SELECT SUM(PURCHASE_AMOUNT) AS REV, AGE_GROUP
FROM CUSTOMER
GROUP BY AGE_GROUP;

